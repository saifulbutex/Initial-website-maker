<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DHT22 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/justgage@1.3.5/justgage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
  <style>
    body { font-family: Arial; text-align:center; }
    .dashboard { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; }
    .chart-container, .gauge-container { width: 300px; height: 200px; }
  </style>
</head>
<body>
  <h1>DHT22 Sensor Dashboard</h1>
  <div class="dashboard">
    <div>
      <canvas id="tempChart" class="chart-container"></canvas>
      <div id="tempGauge" class="gauge-container"></div>
    </div>
    <div>
      <canvas id="humChart" class="chart-container"></canvas>
      <div id="humGauge" class="gauge-container"></div>
    </div>
  </div>

  <script>
    const channelID = "3138187";              
    const readAPIKey = "7BMMGR80OZBO8PIU";   
    const resultsCount = 20;

    let tempChart, humChart, tempGauge, humGauge;

    async function fetchData() {
      const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=${resultsCount}`;
      const response = await fetch(url);
      const data = await response.json();

      const timestamps = data.feeds.map(f => f.created_at.substring(11,19));
      const tempData = data.feeds.map(f => parseFloat(f.field1));
      const humData = data.feeds.map(f => parseFloat(f.field2));

      // Calculate averages
      const avgTemp = (tempData.reduce((a,b) => a+b,0)/tempData.length).toFixed(1);
      const avgHum = (humData.reduce((a,b) => a+b,0)/humData.length).toFixed(1);

      // Update or create temperature chart
      if (!tempChart) {
        const ctx = document.getElementById('tempChart').getContext('2d');
        tempChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: timestamps,
            datasets: [{ label: 'Temperature (°C)', data: tempData, borderColor:'red', fill:false }]
          },
          options: { responsive: true, plugins:{legend:{display:false}}, scales:{x:{display:false}} }
        });
      } else {
        tempChart.data.labels = timestamps;
        tempChart.data.datasets[0].data = tempData;
        tempChart.update();
      }

      // Update or create humidity chart
      if (!humChart) {
        const ctx2 = document.getElementById('humChart').getContext('2d');
        humChart = new Chart(ctx2, {
          type: 'line',
          data: {
            labels: timestamps,
            datasets: [{ label: 'Humidity (%)', data: humData, borderColor:'blue', fill:false }]
          },
          options: { responsive: true, plugins:{legend:{display:false}}, scales:{x:{display:false}} }
        });
      } else {
        humChart.data.labels = timestamps;
        humChart.data.datasets[0].data = humData;
        humChart.update();
      }

      // Update gauges
      if (!tempGauge) {
        tempGauge = new JustGage({
          id: "tempGauge",
          value: avgTemp,
          min: 0,
          max: 50,
          title: "Avg Temp (°C)",
          label: ""
        });
      } else { tempGauge.refresh(avgTemp); }

      if (!humGauge) {
        humGauge = new JustGage({
          id: "humGauge",
          value: avgHum,
          min: 0,
          max: 100,
          title: "Avg Humidity (%)",
          label: ""
        });
      } else { humGauge.refresh(avgHum); }
    }

    fetchData();
    setInterval(fetchData, 15000); // Refresh every 15s
  </script>
</body>
</html>
