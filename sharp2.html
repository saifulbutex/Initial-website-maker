<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dust Monitoring Dashboard (ThingSpeak)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0; padding: 0;
      background-color: #f8f9fa;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 { margin-top: 10px; text-align: center; }
    .summary {
      display: flex; justify-content: center; flex-wrap: wrap;
      gap: 1rem; margin: 10px 0 20px 0;
    }
    .card {
      background: white; border-radius: 12px;
      padding: 15px 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      min-width: 160px; text-align: center; font-size: 15px;
    }
    #aqStatus { font-weight: bold; padding: 4px 10px; border-radius: 6px; }
    .chart-container {
      width: 90%; max-width: 900px; height: 400px;
      background: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 10px; margin-bottom: 20px;
    }
    .bottom-section {
      width: 90%; max-width: 900px;
      background: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 15px; margin-bottom: 30px;
    }
    table {
      width: 100%; border-collapse: collapse; font-size: 14px;
    }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 8px; text-align: center; }
    th { background-color: #e9ecef; }
    #exportBtn {
      background: #007bff; color: white; border: none;
      padding: 8px 16px; border-radius: 6px; cursor: pointer;
      margin-top: 10px;
    }
    #exportBtn:hover { background: #0056b3; }
    @media (max-width: 600px) {
      .chart-container { height: 250px; }
      .summary .card { font-size: 13px; min-width: 130px; }
    }
  </style>
</head>
<body>

<h2>üå´Ô∏è Dust Monitoring Dashboard</h2>

<div class="summary">
  <div class="card">Current Dust<br><span id="currentDust">--</span> ¬µg/m¬≥</div>
  <div class="card">Avg (10 samples)<br><span id="avgDust">--</span> ¬µg/m¬≥</div>
  <div class="card">CV% (last 20)<br><span id="cvTop">--</span></div>
  <div class="card">Air Quality<br><span id="aqStatus">--</span></div>
  <div class="card">Today‚Äôs PM10<br><span id="todayPM10">--</span></div>
</div>

<div class="chart-container">
  <canvas id="dustChart"></canvas>
</div>

<div class="bottom-section">
  <h3>Recorded Data</h3>
  <table id="dataTable">
    <thead>
      <tr>
        <th>Timestamp (GMT+6)</th>
        <th>Dust (¬µg/m¬≥)</th>
        <th>AQI</th>
        <th>CV% (1 min)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="exportBtn">Download CSV</button>
</div>

<script>
  const channelID = "3148948";
  const readAPIKey = "41YJ4QCD1RAGKEJ4";
  const resultsCount = 20;
  const weatherAPIKey = "b3bfbea577fbd677b558cb26bb442204";

  const ctx = document.getElementById('dustChart').getContext('2d');
  const dustChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Dust (¬µg/m¬≥)', data: [], borderColor: 'rgba(0, 123, 255, 0.9)', backgroundColor: 'rgba(0, 123, 255, 0.1)', fill: true, tension: 0.3 }] },
    options: { responsive: true, scales: { x: { title: { display: true, text: 'Time' } }, y: { title: { display: true, text: 'Dust (¬µg/m¬≥)' } } } }
  });

  function getAirQualityStatus(dust) {
    if (dust <= 35) return { text: "Clean", color: "#28a745" };
    if (dust <= 75) return { text: "Moderate", color: "#ffc107" };
    if (dust <= 150) return { text: "Unhealthy", color: "#fd7e14" };
    return { text: "Hazardous", color: "#dc3545" };
  }

  function getAQI_PM10(pm10) {
    if(pm10 <= 54) return Math.round((pm10/54)*50);
    if(pm10 <= 154) return Math.round(51 + (pm10-55)*(100-51)/(154-55));
    if(pm10 <= 254) return Math.round(101 + (pm10-155)*(150-101)/(254-155));
    if(pm10 <= 354) return Math.round(151 + (pm10-255)*(200-151)/(354-255));
    if(pm10 <= 424) return Math.round(201 + (pm10-355)*(300-201)/(424-355));
    if(pm10 <= 504) return Math.round(301 + (pm10-425)*(400-301)/(504-425));
    return Math.round(401 + (pm10-505)*(500-401)/(604-505));
  }

  function calculateCV(values) {
    if (values.length===0) return 0;
    const mean = values.reduce((a,b)=>a+b,0)/values.length;
    const stdDev = Math.sqrt(values.map(v=> (v-mean)**2).reduce((a,b)=>a+b)/values.length);
    return ((stdDev/mean)*100).toFixed(2);
  }

  async function fetchDustData() {
    try {
      const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=${resultsCount}`;
      const response = await fetch(url);
      const data = await response.json();
      const dustData = data.feeds.map(f => parseFloat(f.field1));
      const timestamps = data.feeds.map(f => {
        const utcDate = new Date(f.created_at);
        utcDate.setHours(utcDate.getHours() + 6); // GMT+6
        return utcDate.toTimeString().substring(0,8);
      });
      if(dustData.length === 0) return;

      dustChart.data.labels = timestamps;
      dustChart.data.datasets[0].data = dustData;
      dustChart.update();

      const current = dustData[dustData.length-1];
      const avg = (dustData.reduce((a,b)=>a+b,0)/dustData.length).toFixed(1);
      const cvTop = calculateCV(dustData);

      document.getElementById('currentDust').textContent = current.toFixed(1);
      document.getElementById('avgDust').textContent = avg;
      document.getElementById('cvTop').textContent = cvTop;

      const aq = getAirQualityStatus(current);
      const aqElem = document.getElementById('aqStatus');
      aqElem.textContent = aq.text;
      aqElem.style.color = aq.color;

      const tbody = document.querySelector("#dataTable tbody");
      const cvRow = calculateCV(dustData.slice(-1)); // CV% per last sample (1 min)
      const row = tbody.insertRow(0);
      row.insertCell(0).textContent = timestamps[timestamps.length-1];
      row.insertCell(1).textContent = current.toFixed(1);
      row.insertCell(2).textContent = getAQI_PM10(current);
      row.insertCell(3).textContent = cvRow;
      if(tbody.rows.length>100) tbody.deleteRow(100);

    } catch (error) { console.error("Error fetching ThingSpeak data:", error); }
  }

  async function fetchPM10Weather() {
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        try {
          const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${weatherAPIKey}`;
          const res = await fetch(url);
          const data = await res.json();
          const pm10 = data.list[0].components.pm10;
          document.getElementById('todayPM10').textContent = pm10.toFixed(1) + " (OpenWeatherMap)";
        } catch(e){ console.error("Weather fetch error:", e); }
      }, err => { console.error("Geolocation denied or failed", err); });
    } else console.warn("Geolocation not supported");
  }

  fetchDustData();
  fetchPM10Weather();
  setInterval(fetchDustData, 20000); // ThingSpeak
  setInterval(fetchPM10Weather, 1800000); // Weather every 30 min

  document.getElementById("exportBtn").addEventListener("click", ()=>{
    let csv = "Timestamp,Dust,AQI,CV%\n";
    document.querySelectorAll("#dataTable tbody tr").forEach(row=>{
      csv += Array.from(row.children).map(td=>td.innerText).join(",")+"\n";
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "dust_data.csv";
    link.click();
  });
</script>

</body>
</html>
