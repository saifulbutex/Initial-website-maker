<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air Monitoring Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: "Segoe UI", sans-serif; margin:0; padding:0; background:#f8f9fa; color:#333; }
h2 { margin-top:10px; text-align:center; }
.nav { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin:15px 0; }
.nav button { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; background:#007bff; color:white; font-weight:bold; flex:1; min-width:100px; }
.nav button.active { background:#0056b3; }
.tab { display:none; width:95%; max-width:1000px; margin:0 auto; }
.summary { display:flex; justify-content:center; flex-wrap:wrap; gap:1rem; margin:10px 0 20px 0; }
.card { background:white; border-radius:12px; padding:15px 20px; box-shadow:0 2px 6px rgba(0,0,0,0.1); min-width:140px; flex:1 1 140px; text-align:center; font-size:15px; }
#aqStatus { font-weight:bold; padding:4px 10px; border-radius:6px; display:inline-block; }
.chart-scroll { display:flex; flex-direction:column; gap:20px; padding-right:10px; overflow-x:auto; }
.chart-container { width:100%; max-width:100%; height:300px; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:10px; }
table { width:100%; border-collapse:collapse; font-size:14px; display:block; overflow-x:auto; white-space:nowrap; }
table, th, td { border:1px solid #ddd; }
th, td { padding:8px; text-align:center; }
th { background-color:#e9ecef; }
#exportBtn { background:#007bff; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; margin-top:10px; }
#exportBtn:hover { background:#0056b3; }

/* MOBILE RESPONSIVE */
@media (max-width:768px){
  .summary { flex-direction:column; align-items:center; }
  .card { font-size:14px; min-width:100%; }
  .chart-container { height:250px; }
  .nav button { font-size:14px; }
}
@media (max-width:480px){
  .card { font-size:13px; padding:12px 16px; }
  h2 { font-size:18px; }
  .chart-container { height:200px; }
}
</style>
</head>
<body>

<h2>Air Monitoring Dashboard</h2>

<div class="nav">
  <button class="tabBtn active" data-tab="homeTab">Home</button>
  <button class="tabBtn" data-tab="graphsTab">Graphs</button>
  <button class="tabBtn" data-tab="tableTab">Table</button>
</div>

<!-- HOME TAB -->
<div id="homeTab" class="tab" style="display:block;">
  <div class="summary">
    <div class="card">Current Dust<br><span id="currentDust">--</span> µg/m³</div>
    <div class="card">Air Quality<br><span id="aqStatus">--</span></div>
    <div class="card">Temperature<br><span id="temp">--</span> °C</div>
    <div class="card">Humidity<br><span id="hum">--</span> %</div>
    <div class="card">CO PPM<br><span id="co">--</span></div>
    <div class="card">Today’s PM10<br><span id="todayPM10">--</span></div>
    <div class="card">Source<br><span id="pmSource">--</span></div>
  </div>
</div>

<!-- GRAPHS TAB -->
<div id="graphsTab" class="tab">
  <div class="chart-scroll">
    <div class="chart-container"><canvas id="dustChart"></canvas></div>
    <div class="chart-container"><canvas id="aqiChart"></canvas></div>
    <div class="chart-container"><canvas id="tempChart"></canvas></div>
    <div class="chart-container"><canvas id="humChart"></canvas></div>
    <div class="chart-container"><canvas id="coChart"></canvas></div>
  </div>
</div>

<!-- TABLE TAB -->
<div id="tableTab" class="tab">
  <table id="dataTable">
    <thead>
      <tr>
        <th>Timestamp (GMT+6)</th>
        <th>PM10 (µg/m³)</th>
        <th>AQI</th>
        <th>Temperature (°C)</th>
        <th>Humidity (%)</th>
        <th>CO PPM</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="exportBtn">Download CSV</button>
</div>

<script>
// ========== Tab Switching ==========
document.querySelectorAll(".tabBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tab").forEach(tab=>tab.style.display="none");
    document.getElementById(btn.dataset.tab).style.display="block";
  });
});

// ========== Config ==========
const tsChannelID = "3156704";
const tsReadKey = "FMLEKZG44JP98RD9";
const resultsCount = 20;
const weatherAPIKey = "b3bfbea577fbd677b558cb26bb442204";

// ========== Charts ==========
const dustChart = new Chart(document.getElementById('dustChart').getContext('2d'), {type:'line', data:{labels:[], datasets:[{label:'PM10 µg/m³', data:[], borderColor:'rgba(0,123,255,0.9)', backgroundColor:'rgba(0,123,255,0.1)', fill:true, tension:0.3}]}});
const aqiChart = new Chart(document.getElementById('aqiChart').getContext('2d'), {type:'line', data:{labels:[], datasets:[{label:'AQI', data:[], borderColor:'rgba(255,99,132,0.9)', backgroundColor:'rgba(255,99,132,0.1)', fill:true, tension:0.3}]}});
const tempChart = new Chart(document.getElementById('tempChart').getContext('2d'), {type:'line', data:{labels:[], datasets:[{label:'Temperature °C', data:[], borderColor:'rgba(255,159,64,0.9)', backgroundColor:'rgba(255,159,64,0.1)', fill:true, tension:0.3}]}});
const humChart = new Chart(document.getElementById('humChart').getContext('2d'), {type:'line', data:{labels:[], datasets:[{label:'Humidity %', data:[], borderColor:'rgba(75,192,192,0.9)', backgroundColor:'rgba(75,192,192,0.1)', fill:true, tension:0.3}]}});
const coChart = new Chart(document.getElementById('coChart').getContext('2d'), {type:'line', data:{labels:[], datasets:[{label:'CO PPM', data:[], borderColor:'rgba(153,102,255,0.9)', backgroundColor:'rgba(153,102,255,0.1)', fill:true, tension:0.3}]}});

// ========== Air Quality ==========
function getAirQualityStatus(dust){
  if(dust<=50) return {text:"Good", color:"#28a745"};
  if(dust<=100) return {text:"Moderate", color:"#ffc107"};
  if(dust<=150) return {text:"Unhealthy-Sensitive", color:"#fd7e14"};
  if(dust<=200) return {text:"Unhealthy", color:"#dc3545"};
  if(dust<=300) return {text:"Very Unhealthy", color:"#800080"};
  return {text:"Hazardous", color:"#4B0082"};
}
function getAQI_PM10(pm10){
  if(pm10<=54) return Math.round((pm10/54)*50);
  if(pm10<=154) return Math.round(51 + (pm10-55)*(100-51)/(154-55));
  if(pm10<=254) return Math.round(101 + (pm10-155)*(150-101)/(254-155));
  if(pm10<=354) return Math.round(151 + (pm10-255)*(200-151)/(354-255));
  if(pm10<=424) return Math.round(201 + (pm10-355)*(300-201)/(424-355));
  if(pm10<=504) return Math.round(301 + (pm10-425)*(400-301)/(504-425));
  return Math.round(401 + (pm10-505)*(500-401)/(604-505));
}

// ========== ThingSpeak Fetch ==========
async function fetchThingSpeak(){
  try{
    const url = `https://api.thingspeak.com/channels/${tsChannelID}/feeds.json?api_key=${tsReadKey}&results=${resultsCount}`;
    const resp = await fetch(url);
    const data = await resp.json();

    const timestamps = data.feeds.map(f=>new Date(f.created_at).toLocaleTimeString('en-US',{hour12:false, timeZone:'Asia/Dhaka'}));
    const pm10Arr = data.feeds.map(f=>parseFloat(f.field1));
    const aqiArr  = data.feeds.map(f=>parseFloat(f.field2));
    const tempArr = data.feeds.map(f=>parseFloat(f.field3));
    const humArr  = data.feeds.map(f=>parseFloat(f.field4));
    const coArr   = data.feeds.map(f=>parseFloat(f.field5));

    if(pm10Arr.length===0) return;

    const currentPM10 = pm10Arr[pm10Arr.length-1];
    document.getElementById('currentDust').textContent = currentPM10.toFixed(1);
    document.getElementById('temp').textContent = tempArr[tempArr.length-1].toFixed(1);
    document.getElementById('hum').textContent = humArr[humArr.length-1].toFixed(1);
    document.getElementById('co').textContent = coArr[coArr.length-1].toFixed(2);

    const aq = getAirQualityStatus(currentPM10);
    const aqElem = document.getElementById('aqStatus');
    aqElem.textContent = aq.text;
    aqElem.style.color = aq.color;

    function updateChart(chart, arr){ chart.data.labels = timestamps; chart.data.datasets[0].data = arr; chart.update(); }
    updateChart(dustChart, pm10Arr);
    updateChart(aqiChart, aqiArr);
    updateChart(tempChart, tempArr);
    updateChart(humChart, humArr);
    updateChart(coChart, coArr);

    // Table
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    for(let i=pm10Arr.length-1;i>=0;i--){
      const row = tbody.insertRow();
      row.insertCell(0).textContent = timestamps[i];
      row.insertCell(1).textContent = pm10Arr[i].toFixed(1);
      row.insertCell(2).textContent = aqiArr[i];
      row.insertCell(3).textContent = tempArr[i].toFixed(1);
      row.insertCell(4).textContent = humArr[i].toFixed(1);
      row.insertCell(5).textContent = coArr[i].toFixed(2);
    }

  } catch(e){ console.error("ThingSpeak error:", e); }
}

// ========== Weather PM10 ==========
function fetchWeatherPM10(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      try{
        const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${weatherAPIKey}`;
        const res = await fetch(url);
        const data = await res.json();
        const pm10 = data.list[0].components.pm10;
        document.getElementById('todayPM10').textContent = pm10.toFixed(1);
        document.getElementById('pmSource').textContent = "OpenWeatherMap";
      } catch(e){ console.error(e); }
    }, err=>{ console.error("Geolocation denied or failed", err); });
  }
}

// ========== CSV Download ==========
document.getElementById("exportBtn").addEventListener("click", ()=>{
  let csv = "Timestamp,PM10,AQI,Temperature,Humidity,CO PPM\n";
  document.querySelectorAll("#dataTable tbody tr").forEach(row=>{
    csv += Array.from(row.children).map(td=>td.innerText).join(",")+"\n";
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "dust_data.csv";
  link.click();
});

// ========== Auto Refresh ==========
fetchThingSpeak();
fetchWeatherPM10();
setInterval(fetchThingSpeak, 20000);
setInterval(fetchWeatherPM10, 1800000);
</script>
</body>
</html>



